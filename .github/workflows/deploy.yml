name: Build & Deploy Go Backend

on:
  push:
    branches: [master]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # 3Ô∏è‚É£ Download deps
      - name: Download deps
        run: go mod download

      # 4Ô∏è‚É£ Run tests
      - name: Run tests
        run: go test ./...

      # 5Ô∏è‚É£ Build Linux binary
      - name: Build Linux binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o app ./cmd

      # 6Ô∏è‚É£ Upload binary to server
      - name: Upload binary to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: app
          target: /var/www/be-go-flush/app.new
          overwrite: true

      # 7Ô∏è‚É£ Move binary and restart service
      - name: Restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mv /var/www/be-go-flush/app.new /var/www/be-go-flush/app
            chmod +x /var/www/be-go-flush/app
            sudo systemctl restart be-go-flush

      # 8Ô∏è‚É£ Discord notification
      - name: Discord notify
        if: always()
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          curl -H "Content-Type: application/json" \
            -d "{
              \"username\": \"Deploy Bot\",
              \"avatar_url\": \"https://i.imgur.com/4M34hi2.png\",
              \"embeds\": [{
                \"title\": \"üöÄ Go Backend Deploy\",
                \"url\": \"https://github.com/caseapia/be-go-flush/commit/${{ github.sha }}\",
                \"color\": 3066993,
                \"fields\": [
                  { \"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true },
                  { \"name\": \"Commit\", \"value\": \"${{ github.sha }}\", \"inline\": true },
                  { \"name\": \"Actor\", \"value\": \"${{ github.actor }}\", \"inline\": true },
                  { \"name\": \"Status\", \"value\": \"${{ job.status }}\", \"inline\": true },
                  { \"name\": \"Time\", \"value\": \"$TIMESTAMP\", \"inline\": true }
                ],
                \"footer\": { \"text\": \"Auto-deploy via GitHub Actions\" }
              }]
            }" ${{ secrets.DISCORD_WEBHOOK }}
      - name: Notify server started
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"username\": \"Deploy Bot\",
              \"embeds\": [{
                \"title\": \"üöÄ Go Backend Deployed\",
                \"color\": 3066993,
                \"fields\": [
                  { \"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true },
                  { \"name\": \"Commit\", \"value\": \"${{ github.sha }}\", \"inline\": true },
                  { \"name\": \"Actor\", \"value\": \"${{ github.actor }}\", \"inline\": true },
                  { \"name\": \"Status\", \"value\": \"Server started\", \"inline\": true }
                ],
                \"footer\": { \"text\": \"GitHub Actions Deploy\" }
              }]
            }" ${{ secrets.DISCORD_WEBHOOK }}
