name: Deploy Go Backend

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v3

      # Setup Go
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      # Build backend
      - name: Build backend
        run: |
          set -o pipefail
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o be-go-flush ./cmd
          ls -lh be-go-flush

      # Copy binary to server
      - name: Deploy backend
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "be-go-flush"
          target: "${{ secrets.APP_PATH }}/be-go-flush"

      # Restart backend
      - name: Restart backend
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ${{ secrets.APP_PATH }}
            pkill -f be-go-flush || true
            nohup ./be-go-flush > app.log 2>&1 &

      # Discord notification
      - name: Notify Discord
        run: |
          STATUS=$([[ ${{ job.status }} == "success" ]] && echo "✅ Success" || echo "❌ Failed")
          curl -H "Content-Type: application/json" -X POST -d '{
            "content": "'"$STATUS"'",
            "embeds": [{"title":"Go Backend Deploy","description":"Commit: $GITHUB_SHA\nActor: $GITHUB_ACTOR"}]
          }' ${{ secrets.DISCORD_WEBHOOK }}
